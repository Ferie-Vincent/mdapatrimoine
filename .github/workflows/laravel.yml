name: Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

    steps:
      # 1) Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) PHP + Composer
      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, intl, pdo_mysql, bcmath
          coverage: none

      - name: Composer install
        run: composer install --no-dev --optimize-autoloader --no-interaction

      # 3) Node + Vite build
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: NPM install + build
        run: |
          npm ci
          npm run build

      # 4) SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "$SSH_PORT" "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null

      # 5) Deploy via rsync
      - name: Sync code to server
        run: |
          set -e
          RSYNC_SSH="ssh -4 -p $SSH_PORT -o StrictHostKeyChecking=yes -o ConnectTimeout=15"

          echo "SSH preflight check..."
          if ! $RSYNC_SSH -T "$SSH_USER@$SSH_HOST" 'echo ok'; then
            echo "SSH connection failed"
            exit 1
          fi

          echo "Syncing files..."
          rsync -az --delete -e "$RSYNC_SSH" \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "tests" \
            --exclude "node_modules" \
            --exclude ".env" \
            --exclude "storage/logs" \
            --exclude "storage/app" \
            --exclude "storage/framework/sessions" \
            --exclude "storage/framework/cache" \
            ./ "$SSH_USER@$SSH_HOST:$DEPLOY_PATH/"

      # 6) Artisan commands on server
      - name: Run post-deploy commands
        run: |
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" << 'EOF'
          set -e
          cd ${{ secrets.DEPLOY_PATH }}

          PHP_BIN="/opt/alt/php84/usr/bin/php"

          echo "PHP version:"
          "$PHP_BIN" -v

          echo "Fix permissions..."
          chmod -R 775 storage bootstrap/cache 2>/dev/null || true

          echo "Migrations..."
          "$PHP_BIN" artisan migrate --force

          echo "Storage link..."
          "$PHP_BIN" artisan storage:link 2>/dev/null || true

          echo "Optimize..."
          "$PHP_BIN" artisan optimize:clear
          "$PHP_BIN" artisan optimize

          echo "Deploy complete."
          EOF
